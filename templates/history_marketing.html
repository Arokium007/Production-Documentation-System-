{% extends "base.html" %}

{% block content %}
<div class="max-w-7xl mx-auto" 
     x-data='{ 
        modalOpen: false, 
        selectedProduct: null, 
        products: {{ products_json | safe }},
        openTimeline(product) {
            this.selectedProduct = product;
            this.modalOpen = true;
            document.body.classList.add("overflow-hidden"); // Prevent background scroll
        },
        closeModal() {
            this.modalOpen = false;
            document.body.classList.remove("overflow-hidden");
            setTimeout(() => this.selectedProduct = null, 300); // Clear after animation
        }
     }'>

    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
        <div>
            <h2 class="text-3xl font-extrabold text-gray-900 tracking-tight">PIS Journey History</h2>
            <p class="text-gray-500 mt-1">Detailed audit log of Product Information Sheet creation and approvals.</p>
        </div>
    </div>

    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden animate-fade-in">
        <div class="p-6 border-b border-gray-100 bg-gray-50/30">
             <h3 class="font-bold text-gray-800">Product List</h3>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full text-left border-collapse">
                <thead class="bg-gray-50/50 border-b border-gray-100">
                    <tr>
                        <th class="px-6 py-4 text-xs font-bold text-gray-400 uppercase tracking-wider">Product Info</th>
                        <th class="px-6 py-4 text-xs font-bold text-gray-400 uppercase tracking-wider">Initiated Date</th>
                        <th class="px-6 py-4 text-xs font-bold text-gray-400 uppercase tracking-wider">Current PIS Status</th>
                        <th class="px-6 py-4 text-xs font-bold text-gray-400 uppercase tracking-wider text-right">View details</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-50">
                    <template x-for="p in products" :key="p.id">
                    <tr class="hover:bg-gray-50/80 transition-colors group cursor-pointer" @click="openTimeline(p)">
                        <td class="px-6 py-4">
                            <div class="flex items-center gap-4">
                                <div class="w-10 h-10 rounded-lg bg-gray-100 border border-gray-200 overflow-hidden flex-shrink-0 relative">
                                    <template x-if="p.image_path">
                                        <img :src="p.image_path" class="w-full h-full object-cover">
                                    </template>
                                    <template x-if="!p.image_path">
                                        <div class="flex items-center justify-center h-full text-gray-400">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                                        </div>
                                    </template>
                                </div>
                                <div>
                                    <div class="font-bold text-gray-900" x-text="p.model_name"></div>
                                    <div class="text-xs text-gray-500" x-text="p.brand"></div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 text-sm font-medium text-gray-700" x-text="p.created_date"></td>
                        <td class="px-6 py-4">
                            <span class="px-3 py-1.5 rounded-full text-xs font-bold inline-flex items-center gap-1.5"
                                  :class="{
                                      'bg-gray-100 text-gray-600': p.pis_status === 'Draft',
                                      'bg-purple-50 text-purple-600': p.pis_status === 'Pending Review',
                                      'bg-red-50 text-red-700': p.pis_status === 'Changes Requested',
                                      'bg-green-50 text-green-700': p.pis_status === 'Approved'
                                  }">
                                <svg x-show="p.pis_status === 'Pending Review'" class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                <svg x-show="p.pis_status === 'Changes Requested'" class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                                <svg x-show="p.pis_status === 'Approved'" class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                                <span x-text="p.pis_status"></span>
                            </span>
                        </td>
                        <td class="px-6 py-4 text-right text-gray-400 group-hover:text-blue-600 transition-colors">
                            <svg class="w-6 h-6 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                        </td>
                    </tr>
                    </template>
                </tbody>
            </table>
        </div>
    </div>


    <div x-show="modalOpen" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-gray-900/50 backdrop-blur-sm z-50"
         @click="closeModal()"
         style="display: none;"></div>

    <div x-show="modalOpen" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0 translate-y-4 scale-95"
         x-transition:enter-end="opacity-100 translate-y-0 scale-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100 translate-y-0 scale-100"
         x-transition:leave-end="opacity-0 translate-y-4 scale-95"
         class="fixed inset-0 z-50 flex items-center justify-center p-4 pointer-events-none"
         style="display: none;">
         
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl max-h-[90vh] pointer-events-auto flex flex-col relative">
            
            <button @click="closeModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 bg-gray-100 hover:bg-gray-200 p-2 rounded-full transition-colors z-10">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>

            <div class="p-8 border-b border-gray-100 flex-shrink-0">
                <template x-if="selectedProduct">
                    <div class="flex items-center gap-6">
                        <div class="w-20 h-20 bg-gray-100 rounded-xl border border-gray-200 overflow-hidden flex-shrink-0">
                             <template x-if="selectedProduct.image_path">
                                <img :src="selectedProduct.image_path" class="w-full h-full object-cover">
                            </template>
                            <template x-if="!selectedProduct.image_path">
                                <div class="flex items-center justify-center h-full text-gray-400">
                                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                                </div>
                            </template>
                        </div>
                        <div>
                            <h3 class="text-2xl font-extrabold text-gray-900" x-text="selectedProduct.model_name"></h3>
                            <p class="text-gray-500" x-text="selectedProduct.brand"></p>
                        </div>
                    </div>
                </template>
            </div>

            <div class="p-8 overflow-y-auto flex-1 smooth-scroll-area bg-gray-50/50">
                <h4 class="text-lg font-bold text-gray-900 mb-6 flex items-center gap-2">
                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    PIS Journey Timeline
                </h4>
                
                <template x-if="selectedProduct">
                    <div class="ml-4 border-l-2 border-gray-200 space-y-8 pl-8 relative">
                        
                        <template x-for="(event, index) in selectedProduct.timeline" :key="index">
                        <div class="relative animate-fade-in-up">
                            
                            <div class="absolute -left-[41px] top-0 p-2 rounded-full border-2 bg-white z-10"
                                 :class="{
                                    'border-gray-200 text-gray-400': event.status === 'neutral',
                                    'border-blue-200 text-blue-600 shadow-sm shadow-blue-100': event.status === 'waiting',
                                    'border-red-200 text-red-600 shadow-sm shadow-red-100': event.status === 'action',
                                    'border-green-200 text-green-600 shadow-sm shadow-green-100': event.status === 'success'
                                 }">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" :d="event.icon"/>
                                </svg>
                            </div>

                            <div class="bg-white p-5 rounded-2xl border border-gray-100 shadow-sm relative group hover:border-gray-300 transition-colors">
                                <div class="w-4 h-4 bg-white border-b border-l border-gray-100 absolute top-4 -left-2.5 transform rotate-45 group-hover:border-gray-300 transition-colors"></div>
                                
                                <div class="flex justify-between items-start mb-2">
                                    <h5 class="font-bold text-gray-900 text-lg" x-text="event.title"></h5>
                                    <div class="text-right flex flex-col items-end">
                                        <div class="font-bold text-gray-900 text-sm" x-text="event.date"></div>
                                        <div class="text-xs text-gray-400" x-text="event.time"></div>
                                    </div>
                                </div>
                                
                                <p class="text-gray-600 mb-3 text-sm leading-relaxed" x-text="event.description"></p>
                                
                                <div class="flex items-center gap-2 text-xs font-medium text-gray-500 uppercase tracking-wide">
                                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                                    <span x-text="event.actor"></span>
                                </div>
                            </div>
                        </div>
                        </template>
                        
                    </div>
                </template>
            </div>

        </div>
    </div>
    </div>

<style>
    @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in-up {
        animation: fadeInUp 0.4s ease-out forwards;
    }
</style>
{% endblock %}